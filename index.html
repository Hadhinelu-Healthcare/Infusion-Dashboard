<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DripStop Dashboard</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --brand:#59A3BE;
}

body {
  font-family: Inter, sans-serif;
  background:#F5F9FC;
  margin:0;
}

.header {
  background:var(--brand);
  color:white;
  padding:18px;
  font-size:26px;
  font-weight:bold;
}

.container {
  padding:20px;
}

.card {
  background:white;
  padding:20px;
  border-radius:14px;
  box-shadow:0 3px 8px rgba(0,0,0,0.08);
  margin-bottom:20px;
}

table {
  width:100%;
  border-collapse:collapse;
}

th {
  background:var(--brand);
  color:white;
  padding:12px;
}

td {
  padding:12px;
  border-bottom:1px solid #eee;
}

.battery {
  width:40px;
  height:18px;
  border:2px solid black;
  border-radius:4px;
  display:flex;
  gap:2px;
  padding:2px;
  position:relative;
}

.battery::after {
  content:"";
  width:5px;
  height:8px;
  background:black;
  position:absolute;
  right:-7px;
  top:4px;
}

.blip {
  flex:1;
  background:#ddd;
  border-radius:2px;
}

.blip-fill { background:#59A3BE; }
.blip-low  { background:red; }

.charging {
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  color:gold;
}
</style>
</head>

<body>

<div class="header">DripStop Cloud Dashboard</div>

<div class="container">

<div class="card">
<table>
<thead>
<tr>
<th>Device</th>
<th>Rate</th>
<th>Drops</th>
<th>Status</th>
<th>Battery</th>
</tr>
</thead>
<tbody id="table"></tbody>
</table>
</div>

</div>

<script>
let devices = {};
const client = new Paho.MQTT.Client("broker.hivemq.com",8884,"/mqtt","WEB_"+Math.random());

client.onMessageArrived = onMessage;
client.connect({useSSL:true,onSuccess:()=>{
  client.subscribe("infusion/+/rate");
  client.subscribe("infusion/+/drops");
  client.subscribe("infusion/+/status");
  client.subscribe("infusion/+/battery");
  client.subscribe("infusion/+/charging");
}});

function onMessage(msg){
  let parts = msg.destinationName.split("/");
  let dev = parts[1];
  let field = parts[2];
  let val = msg.payloadString;

  if(!devices[dev]){
    devices[dev] = {battery:0, charging:0};
    document.getElementById("table").innerHTML += `
      <tr id="row-${dev}">
        <td>${dev}</td>
        <td id="${dev}-rate">-</td>
        <td id="${dev}-drops">-</td>
        <td id="${dev}-status">-</td>
        <td>
          <div class="battery" id="bat-${dev}">
            <div class="blip"></div>
            <div class="blip"></div>
            <div class="blip"></div>
          </div>
        </td>
      </tr>`;
  }

  if(field==="rate") document.getElementById(dev+"-rate").innerText = val;
  if(field==="drops") document.getElementById(dev+"-drops").innerText = val;
  if(field==="status") document.getElementById(dev+"-status").innerText = val;
  if(field==="battery") devices[dev].battery = parseFloat(val);
  if(field==="charging") devices[dev].charging = val;

  updateBattery(dev);
}

function updateBattery(dev){
  const v = devices[dev].battery;
  const charging = devices[dev].charging === "1";
  const blips = document.querySelectorAll("#bat-"+dev+" .blip");

  blips.forEach(b=>b.className="blip");
  document.querySelectorAll("#bat-"+dev+" .charging").forEach(e=>e.remove());

  if(charging){
    document.getElementById("bat-"+dev).innerHTML += `<div class="charging">âš¡</div>`;
    return;
  }

  if(v >= 3.0){
    blips[0].classList.add("blip-fill");
    blips[1].classList.add("blip-fill");
  }
  else if(v >= 2.5){
    blips[0].classList.add("blip-low");
  }
  else{
    blips[0].classList.add("blip-low");
  }
}
</script>
</body>
</html>
