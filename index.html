<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DripStop — Dashboard (clean)</title>

<!-- External libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<!-- Minimal, modern CSS — responsive and clean -->
<style>
:root{
  --bg:#f5f8fa; --card:#fff; --muted:#8b98a6; --accent:#2b8fb8;
  --success:#2ea44f; --danger:#d73a49; --radius:12px; --pad:14px;
  --shadow: 0 6px 18px rgba(34,40,49,0.06);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#1c2733;font-size:15px}
.container{max-width:1100px;margin:18px auto;padding:12px}
.header{display:flex;align-items:center;justify-content:space-between;padding:14px 10px}
.title{font-weight:700;color:var(--accent);font-size:20px}
.small{color:var(--muted);font-size:13px}
.layout{display:grid;grid-template-columns:300px 1fr;gap:18px;padding:0 10px}

/* Sidebar */
.sidebar{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
.sidebar h3{margin:0 0 10px 0;color:#0b3b4a}
.device-list{display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto;padding-right:6px}
.device-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:#f2fbff;cursor:pointer}
.device-row:hover{background:#e9f6fb}
.device-id{font-weight:600}
.device-status{font-size:13px}
.battery{width:42px;height:16px;border-radius:4px;border:2px solid #cfeaf6;display:flex;gap:2px;padding:2px;align-items:center;justify-content:space-between}
.blip{flex:1;background:#e6f4fa;border-radius:2px;height:8px}
.blip.on{background:var(--accent)}
.blip.critical{background:var(--danger)}
.charge-icon{font-size:12px;margin-left:6px}

/* Main area */
.main{display:flex;flex-direction:column;gap:14px}
.cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:var(--shadow)}
.card h4{margin:0;font-size:13px;color:var(--muted)}
.card .value{font-size:22px;font-weight:700;margin-top:6px}

/* Graph area (collapsible if no device selected) */
.graph-wrap{background:var(--card);padding:12px;border-radius:12px;box-shadow:var(--shadow);display:flex;flex-direction:column}
.graph-toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.graph-title{font-weight:700;color:#0b3b4a}
.hide{display:none}

/* Table */
.table-card{background:var(--card);padding:10px;border-radius:12px;box-shadow:var(--shadow)}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;text-align:left;border-bottom:1px solid #eef4f7}
th{color:var(--muted);font-size:13px}

/* Modal */
#overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center}
.modal{width:360px;background:var(--card);padding:16px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.25)}
.modal input, .modal select{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #e6eef3}
.btn{background:var(--accent);color:white;padding:10px 12px;border-radius:8px;border:none;cursor:pointer}
.btn.ghost{background:#eef7fb;color:var(--accent);border:1px solid #dbeff7}

/* small responsive */
@media (max-width:900px){
  .layout{grid-template-columns:1fr;gap:12px}
  .cards{grid-template-columns:repeat(2,1fr)}
  .sidebar{order:2}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="title">DripStop — Live Dashboard</div>
      <div class="small">Broker: broker.hivemq.com (wss://)</div>
    </div>
    <div>
      <button class="btn" onclick="openModal()">Start Infusion</button>
    </div>
  </div>

  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <h3>Devices</h3>
      <div id="device-list" class="device-list"></div>
      <div style="margin-top:12px;font-size:13px;color:var(--muted)">
        Click a device to show live graph & details.
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="cards">
        <div class="card">
          <h4>Selected Device</h4>
          <div class="value" id="selected-device">—</div>
        </div>
        <div class="card">
          <h4>Latest Rate (drops/min)</h4>
          <div class="value" id="stat-rate">—</div>
        </div>
        <div class="card">
          <h4>Total Drops</h4>
          <div class="value" id="stat-drops">—</div>
        </div>
      </div>

      <!-- Graph (hidden until a device is chosen) -->
      <div class="graph-wrap" id="graph-wrap">
        <div class="graph-toolbar">
          <div class="graph-title">Live Drip Rate</div>
          <div class="small">device: <span id="graph-device">—</span></div>
        </div>
        <canvas id="rateChart" height="120"></canvas>
      </div>

      <!-- Table -->
      <div class="table-card">
        <h4 style="margin:0 0 8px 0;">All Devices</h4>
        <table>
          <thead><tr><th>Device</th><th>Rate</th><th>Drops</th><th>Status</th></tr></thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </main>
  </div>
</div>

<!-- START INFUSION MODAL -->
<div id="overlay"><div class="modal" role="dialog" aria-modal="true">
  <h3>Start Infusion</h3>
  <label class="small">Device ID</label>
  <select id="m-device"><option>DEVICE_1</option><option>DEVICE_2</option></select>
  <label class="small">Bottle (mL)</label>
  <input id="m-bottle" type="number" value="500" />
  <label class="small">Drop factor (drops/mL)</label>
  <input id="m-factor" type="number" value="20" />
  <label class="small">Duration (min)</label>
  <input id="m-duration" type="number" value="60" />
  <div style="display:flex;gap:8px;margin-top:10px">
    <button class="btn" onclick="sendStart()">Start</button>
    <button class="btn ghost" onclick="closeModal()">Cancel</button>
  </div>
</div></div>

<!-- JS: MQTT behavior + UI glue -->
<script>
/* ==================== CONFIG ==================== */
const HOST = "broker.hivemq.com";
const PORT = 8884;
const PATH = "/mqtt";
const CLIENT = "WEB_DRIP_" + Date.now();

/* state */
const devices = {};   // deviceId -> {rate, drops, status, battery, charging}
let currentDevice = null;

/* Create MQTT client (Paho) */
const client = new Paho.MQTT.Client(HOST, PORT, PATH, CLIENT);
client.onConnectionLost = (e) => { console.warn("MQTT lost", e); setTimeout(connect,2000); };
client.onMessageArrived = onMessage;

/* connect */
function connect(){
  client.connect({
    onSuccess: () => {
      console.log("MQTT connected");
      client.subscribe("infusion/+/rate");
      client.subscribe("infusion/+/drops");
      client.subscribe("infusion/+/status");
      client.subscribe("infusion/+/battery");
      client.subscribe("infusion/+/charging");
    },
    onFailure: (err)=> { console.error("MQTT connect fail", err); setTimeout(connect,2000); },
    useSSL: true
  });
}
connect();

/* ==================== UI helpers ==================== */
function ensureDevice(id){
  if(!devices[id]) devices[id] = {rate:'-',drops:'-',status:'OFFLINE',battery:0,charging:0};
}
function renderDeviceList(){
  const el = document.getElementById("device-list");
  el.innerHTML = "";
  Object.keys(devices).sort().forEach(id=>{
    const d = devices[id];
    const row = document.createElement("div");
    row.className = "device-row";
    row.onclick = ()=>selectDevice(id);
    row.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <div style="min-width:72px">
          <div class="device-id">${id}</div>
          <div class="small" style="color:${d.status==='ONLINE'?'var(--success)':(d.status==='INFUSING'?'#0b6db7':'var(--muted)')}">${d.status}</div>
        </div>
        <div>
          <div class="battery" title="Battery">
            <div class="blip ${d.battery>=3.9?'on':''}"></div>
            <div class="blip ${d.battery>=3.2?'on':''}"></div>
            <div class="blip ${d.battery>=2.7?'on':''}"></div>
          </div>
        </div>
      </div>
      <div style="text-align:right">
        <div class="small">Rate: ${d.rate}</div>
        <div class="small">Drops: ${d.drops}</div>
      </div>
    `;
    el.appendChild(row);
  });
  renderTable();
}

function renderTable(){
  const tb = document.getElementById("table-body"); tb.innerHTML="";
  Object.keys(devices).sort().forEach(id=>{
    const d = devices[id];
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${id}</td><td>${d.rate}</td><td>${d.drops}</td><td>${d.status}</td>`;
    tb.appendChild(tr);
  });
}

function selectDevice(id){
  currentDevice = id;
  document.getElementById("selected-device").innerText = id;
  document.getElementById("graph-device").innerText = id;
  document.getElementById("stat-rate").innerText = devices[id].rate || '-';
  document.getElementById("stat-drops").innerText = devices[id].drops || '-';
  // show graph area
  document.getElementById("graph-wrap").classList.remove("hide");
  // clear chart and start fresh for this device
  clearChart();
}

/* Modal */
function openModal(){ document.getElementById("overlay").style.display="flex"; }
function closeModal(){ document.getElementById("overlay").style.display="none"; }

/* Send start infusion */
function sendStart(){
  const dev = document.getElementById("m-device").value.trim();
  const bottle = document.getElementById("m-bottle").value.trim();
  const df = document.getElementById("m-factor").value.trim();
  const dur = document.getElementById("m-duration").value.trim();
  if(!dev){ alert("Choose device"); return; }
  const payload = `START:${bottle},${df},${dur}`;
  const msg = new Paho.MQTT.Message(payload);
  msg.destinationName = `infusion/${dev}/cmd`;
  client.send(msg);
  closeModal();
  alert("Start command sent to " + dev);
}

/* ==================== MQTT message handler ==================== */
function onMessage(message){
  const t = message.destinationName;
  const p = message.payloadString;
  const parts = t.split("/");
  if(parts.length < 3) return;
  const id = parts[1];
  const field = parts[2];
  ensureDevice(id);

  if(field === "rate"){
    const n = parseFloat(p);
    devices[id].rate = isNaN(n)?p: n.toFixed(1);
    if(id === currentDevice) pushToChart(n);
  } else if(field === "drops"){
    devices[id].drops = p;
  } else if(field === "status"){
    devices[id].status = p;
    // auto select if INFUSING
    if(p === "INFUSING" && !currentDevice) selectDevice(id);
  } else if(field === "battery"){
    const v = parseFloat(p) || 0; devices[id].battery = v;
  } else if(field === "charging"){
    devices[id].charging = p;
  }

  // refresh UI
  renderDeviceList();
  if(currentDevice){
    document.getElementById("stat-rate").innerText = devices[currentDevice].rate || '-';
    document.getElementById("stat-drops").innerText = devices[currentDevice].drops || '-';
  }
}

/* ==================== Chart (Chart.js) ==================== */
const ctx = document.getElementById("rateChart").getContext("2d");
const rateChart = new Chart(ctx, {
  type: "line",
  data: { labels: [], datasets: [{ label: "drops/min", data: [], backgroundColor: "rgba(43,143,184,0.12)", borderColor: "#2b8fb8", tension:0.3, pointRadius:0 }]},
  options: {
    responsive:true, maintainAspectRatio:false,
    scales:{ x:{display:false}, y:{min:0, max:500} },
    plugins:{ legend:{display:false} },
  }
});
function pushToChart(value){
  if(isNaN(value)) return;
  rateChart.data.labels.push("");
  rateChart.data.datasets[0].data.push(Number(value));
  if(rateChart.data.labels.length > 60){
    rateChart.data.labels.shift(); rateChart.data.datasets[0].data.shift();
  }
  rateChart.update();
}
function clearChart(){ rateChart.data.labels=[]; rateChart.data.datasets[0].data=[]; rateChart.update(); }

/* initially hide graph until user picks a device */
document.getElementById("graph-wrap").classList.add("hide");

/* On load: sample placeholder devices (optional). Remove if you prefer empty start */
(function seedSample(){
  const sample = ["DEVICE_1","DEVICE_2","DEVICE_3"];
  sample.forEach((id,i)=>{
    devices[id] = {rate:(10+i*5).toFixed(1), drops: (100+i*10), status: (i===0?"ONLINE":"READY"), battery: 3.8 - i*0.3};
  });
  renderDeviceList();
})();
</script>
</body>
</html>
