<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DripStop Dashboard</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Paho MQTT -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
    --blue: #59A3BE;
    --blue-dark: #3F7E94;
    --bg: #F7FBFE;
    --card: #FFFFFF;
    --border: #E6EDF3;
    --text: #1C1C1C;
    --text-light: #6C7A89;
    --radius: 14px;
    --shadow: 0px 4px 14px rgba(0,0,0,0.05);
}

/* RESET */
* { margin:0; padding:0; box-sizing:border-box; }
body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
}

/* ===================== TOP NAV ====================== */
.navbar {
    width: 100%;
    background: var(--blue);
    color: white;
    padding: 18px 32px;
    font-size: 24px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.nav-links {
    display: flex;
    gap: 24px;
    font-size: 16px;
}
.nav-links a {
    color: white;
    text-decoration: none;
    font-weight: 500;
    opacity: 0.9;
}
.nav-links a:hover {
    opacity:1;
}

/* ==================== PAGE LAYOUT ==================== */
.container {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 20px;
    padding: 20px;
}

/* =================== SIDEBAR ==================== */
.sidebar {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 18px;
    height: fit-content;
}
.sidebar h3 {
    margin-bottom: 10px;
    color: var(--blue-dark);
    font-size: 18px;
}
.device-item {
    padding: 12px;
    margin-bottom: 8px;
    background: #F0F8FC;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items:center;
}
.device-item:hover {
    background: #D9EEF7;
}
.device-online { color: green; font-weight:600; }
.device-offline { color: red; font-weight:600; }

/* BATTERY ICON */
.battery {
    width: 24px;
    height: 12px;
    border: 2px solid #000;
    border-radius: 3px;
    display: flex;
    gap: 1px;
    padding: 1px;
    position: relative;
    margin-top: 4px;
}
.battery::after {
    content:"";
    width:4px;
    height:6px;
    background:black;
    position:absolute;
    right:-6px;
    top:3px;
    border-radius:2px;
}
.blip {
    flex:1;
    background:#DDD;
    border-radius:2px;
}
.blip-blue { background:#59A3BE; }
.blip-red  { background:red; }

.charging {
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    color:gold;
    font-size:10px;
}

/* blinking for <2.7V */
@keyframes blink {
    0% { opacity:1; }
    50% { opacity:0.1; }
    100% { opacity:1; }
}
.blink {
    animation: blink 1s infinite;
}

/* ==================== DASHBOARD CONTENT ==================== */
.main {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* ==================== INFO CARDS ==================== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
}
.stat-card {
    background: var(--card);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}
.stat-title {
    font-size: 14px;
    color: var(--text-light);
}
.stat-value {
    font-size: 28px;
    font-weight: 700;
    margin-top: 6px;
}

/* ==================== GRAPH CARD ==================== */
.graph-card {
    background: var(--card);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}
.graph-card h3 {
    margin-bottom: 20px;
    color: var(--blue-dark);
}

/* ==================== DEVICE TABLE ==================== */
.table-card {
    background: var(--card);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}
table {
    width: 100%;
    border-collapse: collapse;
}
th {
    background: var(--blue);
    color: white;
    padding: 12px;
    border-radius: 4px;
}
td {
    padding: 12px;
    border-bottom: 1px solid var(--border);
}

/* STATUS COLORS */
.status-ONLINE { color: green; font-weight:bold; }
.status-INFUSING { color: blue; font-weight:bold; }
.status-COMPLETED { color: purple; font-weight:bold; }
.status-READY { color: orange; font-weight:bold; }

/* ==================== START-INFUSION MODAL ==================== */
#modal-overlay {
    position: fixed;
    top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.4);
    display:none;
    align-items:center;
    justify-content:center;
}
.modal {
    background:white;
    padding:24px;
    width:350px;
    border-radius:var(--radius);
    box-shadow:var(--shadow);
}
.modal h2 {
    margin-bottom:12px;
    color: var(--blue-dark);
}
.modal input, .modal select {
    width:100%;
    padding:10px;
    margin:8px 0;
    border:1px solid var(--border);
    border-radius:8px;
}
.modal button {
    width:100%;
    padding:12px;
    background:var(--blue);
    border:none;
    color:white;
    border-radius:8px;
    cursor:pointer;
    font-size:16px;
}

/* ================= SETTINGS PANEL ================= */
.settings {
    background: var(--card);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}
</style>

</head>
<body>

<!-- ================= NAVBAR ================= -->
<div class="navbar">
    DripStop Dashboard
    <div class="nav-links">
        <a href="#">Dashboard</a>
        <a href="#">Devices</a>
        <a href="#" onclick="openSettings()">Settings</a>
    </div>
</div>

<!-- ================= PAGE GRID ================= -->
<div class="container">

    <!-- ========== SIDEBAR ========== -->
    <div class="sidebar">
        <h3>Devices</h3>
        <div id="device-list"></div>
        <button onclick="openModal()" style="
            margin-top:10px;width:100%;
            background:var(--blue);color:white;
            border:none;padding:10px;border-radius:8px;">
            Start Infusion
        </button>
    </div>

    <!-- ========== MAIN DASHBOARD ========== -->
    <div class="main">

        <!-- ========== STAT CARDS ========== -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">Current Drip Rate</div>
                <div class="stat-value" id="stat-rate">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Total Drops</div>
                <div class="stat-value" id="stat-drops">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Status</div>
                <div class="stat-value" id="stat-status">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Graph Device</div>
                <div class="stat-value" id="graph-device">DEVICE_1</div>
            </div>
        </div>

        <!-- ========== GRAPH ========== -->
        <div class="graph-card">
            <h3>Live Drip Rate Graph</h3>
            <canvas id="chart"></canvas>
        </div>

        <!-- ========== TABLE ========== -->
        <div class="table-card">
            <h3>Device Data Table</h3>

            <table>
                <thead>
                  <tr>
                    <th>Device</th>
                    <th>Drip Rate</th>
                    <th>Total Drops</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>

    </div>
</div>

<!-- ========== START-INFUSION MODAL ========== -->
<div id="modal-overlay">
    <div class="modal">
        <h2>Start Infusion</h2>

        <label>Device</label>
        <select id="m-device">
            <option>DEVICE_1</option>
            <option>DEVICE_2</option>
            <option>DEVICE_3</option>
            <option>DEVICE_4</option>
            <option>DEVICE_5</option>
        </select>

        <label>Bottle Volume (mL)</label>
        <input id="m-bottle" type="number" value="500">

        <label>Drop Factor</label>
        <input id="m-factor" type="number" value="20">

        <label>Duration (min)</label>
        <input id="m-duration" type="number" value="60">

        <button onclick="sendStart()">Start</button>
    </div>
</div>

<!-- SETTINGS -->
<div class="settings" id="settings-panel" style="display:none; margin:20px;">
    <h3>Settings</h3>
    <p>More settings can be added here…</p>
</div>

<!-- ================= JAVASCRIPT ================= -->
<script>
let host = "broker.hivemq.com";
let port = 8884;
let path = "/mqtt";
let clientId = "DRIPSTOP_WEB_" + Math.random();

let client = new Paho.MQTT.Client(host, port, path, clientId);

let devices = {};   // stores device state
let currentGraphDevice = "DEVICE_1";

client.onConnectionLost = () => setTimeout(connect, 1000);
client.onMessageArrived = onMessage;

function connect() {
    client.connect({
        onSuccess: () => {
            client.subscribe("infusion/+/rate");
            client.subscribe("infusion/+/drops");
            client.subscribe("infusion/+/status");
            client.subscribe("infusion/+/battery");
            client.subscribe("infusion/+/charging");
        },
        useSSL:true
    });
}
connect();

/* ======================================================
   Device Sidebar + Table Updates
   ====================================================== */

function ensureDevice(id){
    if (!devices[id]){
        devices[id] = {
            rate:"-",
            drops:"-",
            status:"OFFLINE",
            battery:0,
            charging:"0"
        };
    }
}

function updateSidebar(){
    let d = document.getElementById("device-list");
    d.innerHTML = "";
    
    Object.keys(devices).forEach(id => {
        let st = devices[id].status;

        d.innerHTML += `
        <div class="device-item" onclick="selectDevice('${id}')">
            <div>
                <div>${id}</div>
                <div class="battery" id="bat-${id}">
                    <div class="blip"></div>
                    <div class="blip"></div>
                    <div class="blip"></div>
                </div>
            </div>
            <span class="${st==='ONLINE'?'device-online':'device-offline'}">${st}</span>
        </div>`;
    });

    Object.keys(devices).forEach(id => renderBattery(id));
}

function updateTable(){
    let t = document.getElementById("table-body");
    t.innerHTML = "";

    Object.keys(devices).forEach(id => {
        let d = devices[id];
        t.innerHTML += `
        <tr>
            <td>${id}</td>
            <td>${d.rate}</td>
            <td>${d.drops}</td>
            <td class="status-${d.status}">${d.status}</td>
        </tr>`;
    });
}

function selectDevice(id){
    currentGraphDevice = id;
    document.getElementById("graph-device").textContent = id;

    chart.data.labels = [];
    chart.data.datasets[0].data = [];
    chart.update();
}

/* ======================================================
   Handle Incoming MQTT
   ====================================================== */
function onMessage(msg){
    let topic = msg.destinationName;
    let payload = msg.payloadString;

    let parts = topic.split("/");
    let id = parts[1];
    let field = parts[2];

    ensureDevice(id);

    if (field === "rate"){
        let r = parseFloat(payload);
        if (!isNaN(r)){
            devices[id].rate = r.toFixed(1);
            if (id === currentGraphDevice) updateGraph(r);
            document.getElementById("stat-rate").textContent = devices[id].rate;
        }
    }
    else if (field === "drops"){
        devices[id].drops = payload;
        document.getElementById("stat-drops").textContent = payload;
    }
    else if (field === "status"){
        devices[id].status = payload;
        document.getElementById("stat-status").textContent = payload;
    }
    else if (field === "battery"){
        devices[id].battery = parseFloat(payload) || 0;
    }
    else if (field === "charging"){
        devices[id].charging = payload;
    }

    updateSidebar();
    updateTable();
}

/* ======================================================
   Battery Blip Logic
   ====================================================== */
function renderBattery(id){
    const dev = devices[id];
    if (!dev) return;

    const v = dev.battery || 0;
    const charging = (dev.charging === "1" || dev.charging === 1);

    const batEl = document.getElementById(`bat-${id}`);
    if (!batEl) return;

    const oldCharge = batEl.querySelector(".charging");
    if (oldCharge) oldCharge.remove();

    const blips = batEl.querySelectorAll(".blip");
    blips.forEach(b => {
        b.classList.remove("blip-blue","blip-red","blink");
    });

    if (charging){
        const span = document.createElement("div");
        span.className = "charging";
        span.textContent = "⚡";
        batEl.appendChild(span);
        return;
    }

    // Voltage → blips:
    // v < 2.7           : 1 red blinking
    // 2.7 <= v < 3.2    : 1 solid red
    // 3.2 <= v < 3.9    : 2 blue
    // v >= 3.9          : 3 blue

    if (v < 2.7){
        blips[0].classList.add("blip-red","blink");
    } else if (v >= 2.7 && v < 3.2){
        blips[0].classList.add("blip-red");
    } else if (v >= 3.2 && v < 3.9){
        blips[0].classList.add("blip-blue");
        blips[1].classList.add("blip-blue");
    } else if (v >= 3.9){
        blips[0].classList.add("blip-blue");
        blips[1].classList.add("blip-blue");
        blips[2].classList.add("blip-blue");
    }
}

/* ======================================================
   Start Infusion (modal)
   ====================================================== */
function openModal(){ document.getElementById("modal-overlay").style.display = "flex"; }
function closeModal(){ document.getElementById("modal-overlay").style.display = "none"; }

function sendStart(){
    let dev = document.getElementById("m-device").value;
    let bottle = document.getElementById("m-bottle").value;
    let factor = document.getElementById("m-factor").value;
    let duration = document.getElementById("m-duration").value;

    let msg = new Paho.MQTT.Message("START:"+bottle+","+factor+","+duration);
    msg.destinationName = "infusion/" + dev + "/cmd";
    client.send(msg);

    closeModal();
}

/* ======================================================
   SETTINGS PANEL
   ====================================================== */
function openSettings(){
    let s = document.getElementById("settings-panel");
    s.style.display = s.style.display === "none" ? "block" : "none";
}

/* ======================================================
   GRAPH (Chart.js)
   ====================================================== */
const chart = new Chart(document.getElementById("chart"), {
    type:"line",
    data:{
        labels:[],
        datasets:[{
            label:"Drip Rate",
            borderColor: "#59A3BE",
            backgroundColor:"rgba(89,163,190,0.25)",
            data:[],
            tension:0.35,
        }]
    },
    options:{
        responsive:true,
        animation:false,
        scales:{
            x:{ display:false },
            y:{
                beginAtZero:true,
                max:500,
                ticks:{ stepSize:50 }
            }
        }
    }
});

let lastUpdate = 0;
function updateGraph(rate){
    let now = Date.now();

    chart.data.labels.push("");
    chart.data.datasets[0].data.push(rate);

    if(chart.data.labels.length>50){
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }

    if(now-lastUpdate>400){
        chart.update();
        lastUpdate = now;
    }
}
</script>
</body>
</html>
