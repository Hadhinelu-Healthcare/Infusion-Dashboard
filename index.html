<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DripStop — Upgraded Dashboard</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Paho MQTT -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --blue:#2f88a8;
  --accent:#59A3BE;
  --bg:#f4fbff;
  --card:#fff;
  --muted:#7d8b94;
  --danger:#e65b4e;
  --radius:12px;
  --shadow: 0 6px 20px rgba(15,30,40,0.06);
  --glass: rgba(255,255,255,0.6);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto; background:var(--bg); color:#0f1720}
.app {
  display:grid;
  grid-template-columns:260px 1fr;
  gap:20px;
  height:100vh;
  padding:20px;
}

/* Sidebar */
.sidebar {
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.brand {font-weight:700;color:var(--blue);font-size:20px;margin-bottom:6px}
.sidebar .section-title{font-size:13px;color:var(--muted);margin-top:6px;margin-bottom:6px}
.device-item{
  display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;cursor:pointer;
}
.device-item:hover{background:#f0fbff}
.device-id{font-weight:600}
.device-meta{font-size:12px;color:var(--muted)}

/* Top nav inside content column */
.content {
  display:flex;flex-direction:column;gap:12px;
}
.top-row {display:flex;align-items:center;justify-content:space-between;padding:8px 6px}
.controls {display:flex;gap:10px;align-items:center}
.btn {background:var(--blue);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.btn.secondary{background:#fff;border:1px solid var(--border); color:var(--blue)}

/* Main area grid */
.main-grid {
  display:grid;
  grid-template-columns: repeat(3,1fr);
  gap:16px;
  align-items:start;
}

/* cards */
.card {background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow)}
.stat-title{font-size:12px;color:var(--muted)}
.stat-value{font-size:22px;font-weight:700;margin-top:6px}

/* wide graph & tables */
.wide {
  grid-column:1 / span 3;
  display:flex;gap:16px;
}
.graph-card{flex:1;padding:12px}
.table-card{flex:1;padding:12px;max-height:320px;overflow:auto}

/* bottom area smaller cards */
.small-grid {display:grid;grid-template-columns:repeat(3,1fr);gap:12px}

/* slide-in detail panel */
.detail-panel {
  position:fixed;
  right:0;
  top:20px;
  height:calc(100vh - 40px);
  width:520px;
  max-width:calc(100% - 60px);
  background:linear-gradient(180deg, rgba(255,255,255,0.98), #fff);
  border-left:1px solid rgba(15,30,40,0.05);
  box-shadow: -10px 0 30px rgba(10,20,30,0.08);
  transform:translateX(110%);
  transition:transform .28s cubic-bezier(.2,.9,.3,1);
  padding:18px;
  z-index:40;
  overflow:auto;
  border-top-left-radius:12px;
  border-bottom-left-radius:12px;
}
.detail-panel.open { transform: translateX(0%); }
.detail-header { display:flex; justify-content:space-between; align-items:center; gap:10px; border-bottom:1px solid #eef4f7; padding-bottom:10px; margin-bottom:10px }
.detail-title {font-weight:700; color:var(--blue)}
.detail-sub {font-size:13px;color:var(--muted)}

/* logs list */
.logs { margin-top:12px; max-height:220px; overflow:auto; border-radius:8px; border:1px solid #f0f5f7; padding:8px; background:#fbfeff }
.log-item {font-family:monospace;font-size:12px;padding:6px 8px;border-radius:6px;margin-bottom:6px;background:linear-gradient(90deg,#fff,#fbfdff)}

/* history & status pages */
.page { display:none; padding:6px }
.page.active { display:block }

/* smaller responsive tweaks */
@media (max-width:980px){
  .app{grid-template-columns:1fr}
  .detail-panel{width:100%;top:0;height:100vh;border-radius:0}
  .main-grid{grid-template-columns:1fr}
  .wide{flex-direction:column}
}
</style>
</head>
<body>

<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">DripStop Dashboard</div>

    <div class="section-title">Menu</div>
    <div id="menu-items">
      <div class="device-item" data-page="overview" onclick="showPage('overview')">
        <div><div class="device-id">Overview</div><div class="device-meta">All devices</div></div>
        <div>▸</div>
      </div>
      <div class="device-item" data-page="history" onclick="showPage('history')">
        <div><div class="device-id">History</div><div class="device-meta">Past infusions</div></div>
        <div>▸</div>
      </div>
      <div class="device-item" data-page="status" onclick="showPage('status')">
        <div><div class="device-id">Status</div><div class="device-meta">Device health</div></div>
        <div>▸</div>
      </div>
      <div class="device-item" data-page="live" onclick="showPage('live')">
        <div><div class="device-id">Live Tracking</div><div class="device-meta">Event log (all)</div></div>
        <div>▸</div>
      </div>
      <div style="height:12px"></div>
    </div>

    <div class="section-title">Devices</div>
    <div id="device-list" style="display:flex;flex-direction:column;gap:8px"></div>

    <div style="margin-top:auto;display:flex;gap:8px">
      <button class="btn" onclick="openStartModal()">Start Infusion</button>
      <button class="btn" style="background:#fff;color:var(--blue);border:1px solid #e6eef2" onclick="toggleMock()">Mock</button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="content">
    <div class="top-row">
      <div>
        <div style="font-size:18px;font-weight:700">Overview</div>
        <div style="font-size:12px;color:var(--muted)">Live device overview</div>
      </div>
      <div class="controls">
        <div style="font-size:13px;color:var(--muted)">MQTT:</div>
        <div id="mqtt-status" style="padding:6px 10px;border-radius:8px;background:#fff;border:1px solid #eef4f7;font-size:13px">Connecting…</div>
      </div>
    </div>

    <div class="main-grid">

      <div class="card stat-card">
        <div class="stat-title">Current Drip Rate</div>
        <div class="stat-value" id="stat-rate">-</div>
      </div>

      <div class="card stat-card">
        <div class="stat-title">Total Drops (all)</div>
        <div class="stat-value" id="stat-drops">-</div>
      </div>

      <div class="card stat-card">
        <div class="stat-title">Active Devices</div>
        <div class="stat-value" id="stat-active">0</div>
      </div>

      <div class="wide">
        <div class="card graph-card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">Live Drip Rate</div>
            <div style="font-size:12px;color:var(--muted)">Device: <span id="graph-device">—</span></div>
          </div>
          <canvas id="overview-chart" style="height:220px;margin-top:12px"></canvas>
        </div>

        <div class="card table-card">
          <div style="font-weight:700;margin-bottom:10px">Devices</div>
          <div style="max-height:260px;overflow:auto">
            <table style="width:100%;border-collapse:collapse">
              <thead>
                <tr style="text-align:left;color:var(--muted);font-size:13px">
                  <th>Device</th><th>Rate</th><th>Drops</th><th>Status</th>
                </tr>
              </thead>
              <tbody id="table-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="small-grid wide card" style="grid-column:1 / span 3;display:grid;grid-template-columns:repeat(3,1fr)">
        <div class="card">
          <div style="font-weight:700">Live Events</div>
          <div id="live-events" style="font-family:monospace;font-size:12px;max-height:130px;overflow:auto;margin-top:8px"></div>
        </div>
        <div class="card">
          <div style="font-weight:700">Quick Actions</div>
          <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
            <button class="btn" onclick="sendCmdToSelected('PAUSE')">Send PAUSE</button>
            <button class="btn" onclick="sendCmdToSelected('RESUME')">Send RESUME</button>
            <button class="btn" style="background:var(--danger)" onclick="sendCmdToSelected('STOP')">Send STOP</button>
          </div>
        </div>
        <div class="card">
          <div style="font-weight:700">Status Summary</div>
          <div style="margin-top:8px">
            <div>Running: <span id="count-running">0</span></div>
            <div>Paused: <span id="count-paused">0</span></div>
            <div>Offline: <span id="count-offline">0</span></div>
          </div>
        </div>
      </div>

    </div>

    <!-- PAGES (history/status/live) -->
    <div style="margin-top:12px">
      <div id="overview" class="page active">
        <!-- Overview already shown -->
      </div>

      <div id="history" class="page">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">History</div>
            <button class="btn" onclick="clearHistory()">Clear History</button>
          </div>
          <div id="history-list" style="margin-top:12px;max-height:400px;overflow:auto"></div>
        </div>
      </div>

      <div id="status" class="page">
        <div class="card">
          <div style="font-weight:700">Device Status</div>
          <div id="status-list" style="margin-top:12px"></div>
        </div>
      </div>

      <div id="live" class="page">
        <div class="card">
          <div style="font-weight:700">Live Tracking</div>
          <div id="live-all" style="margin-top:8px;max-height:400px;overflow:auto;font-family:monospace"></div>
        </div>
      </div>

    </div>
  </main>

</div>

<!-- DETAIL PANEL -->
<div id="detailPanel" class="detail-panel" aria-hidden="true">
  <div class="detail-header">
    <div>
      <div class="detail-title" id="detail-title">Device —</div>
      <div class="detail-sub" id="detail-sub">Status —</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn" onclick="closeDetail()">Close</button>
    </div>
  </div>

  <div style="display:flex;gap:12px">
    <div style="flex:1">
      <div style="font-weight:700">Live Rate</div>
      <canvas id="detail-chart" style="height:180px;margin-top:8px"></canvas>
    </div>
    <div style="width:160px">
      <div style="font-weight:700">Summary</div>
      <div style="margin-top:8px">
        <div>Rate <div id="d-rate" style="font-weight:700"></div></div>
        <div style="margin-top:8px">Drops <div id="d-drops" style="font-weight:700"></div></div>
        <div style="margin-top:8px">Vol <div id="d-vol" style="font-weight:700"></div></div>
        <div style="margin-top:8px">Remaining <div id="d-rem" style="font-weight:700"></div></div>
      </div>
    </div>
  </div>

  <div style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">Events</div>
      <div style="font-size:13px;color:var(--muted)">Real-time feed</div>
    </div>
    <div id="detail-logs" class="logs" style="margin-top:8px"></div>
  </div>

  <div style="margin-top:14px;display:flex;gap:8px;justify-content:flex-end">
    <button class="btn" onclick="saveHistoryCurrent()">Save to History</button>
  </div>
</div>

<!-- SIMPLE START INFUSION MODAL -->
<div id="startModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center">
  <div style="background:white;padding:18px;border-radius:12px;min-width:320px;">
    <div style="font-weight:700">Start Infusion (demo)</div>
    <div style="margin-top:8px">
      <label>Device ID</label>
      <input id="m-device" value="DEVICE_1" style="width:100%;padding:8px;margin-top:6px"/>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px">
      <input id="m-vol" type="number" value="500" style="flex:1;padding:8px"/>
      <input id="m-factor" type="number" value="20" style="flex:1;padding:8px"/>
      <input id="m-duration" type="number" value="60" style="flex:1;padding:8px"/>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" onclick="startInfusionFromModal()">Start</button>
      <button class="btn" style="background:#fff;color:var(--blue);border:1px solid #eef4f7" onclick="closeStartModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ======= Configuration & State ======= */
const host = "broker.hivemq.com";
const port = 8884;
const path = "/mqtt";
const useSSL = true;
let client = null;
let mqttConnected = false;
let devices = {};               // deviceId -> {rate,drops,status,lastSeen,meta,logs}
let selectedDevice = null;
let overviewChart = null;
let detailChart = null;
let graphDevice = null;
let mockMode = false;

/* ======= Utilities ======= */
function nowISO(){ return new Date().toISOString(); }
function ensureDevice(id){
  if(!devices[id]) devices[id] = { rate: "-", drops: 0, status: "OFFLINE", lastSeen: null, logs: [], meta:{} };
}

/* ======= MQTT Connect ======= */
function setupMQTT(){
  const clientId = "DRIPSTOP_WEB_" + Math.random().toString(36).slice(2,9);
  client = new Paho.MQTT.Client(host, port, path, clientId);
  client.onConnectionLost = () => { mqttConnected = false; setMqttStatus(false); reconnectMQTT(); };
  client.onMessageArrived = msg => handleMQTT(msg.destinationName, msg.payloadString);
  connectMQTT();
}
function connectMQTT(){
  if(!client) setupMQTT();
  try {
    client.connect({
      useSSL,
      onSuccess: () => { mqttConnected = true; setMqttStatus(true);
        client.subscribe("infusion/+/rate");
        client.subscribe("infusion/+/drops");
        client.subscribe("infusion/+/status");
        client.subscribe("infusion/+/meta");
      },
      onFailure: () => { mqttConnected=false; setMqttStatus(false); setTimeout(reconnectMQTT, 2000) }
    });
  } catch(e){ setMqttStatus(false); setTimeout(reconnectMQTT,2000) }
}
function reconnectMQTT(){ setTimeout(()=>{ if(!mqttConnected) connectMQTT() }, 2000) }
function setMqttStatus(ok){
  const el = document.getElementById("mqtt-status");
  el.textContent = ok ? "Connected" : "Disconnected (mock available)";
  el.style.background = ok ? "transparent" : "#fff";
}

/* ======= Handle Incoming MQTT ======= */
function handleMQTT(topic, payload){
  const parts = topic.split("/");
  if(parts[0] !== "infusion") return;
  const id = parts[1]; const field = parts[2];
  ensureDevice(id);
  const dev = devices[id];
  dev.lastSeen = Date.now();
  if(field === "rate"){
    const r = parseFloat(payload);
    dev.rate = isNaN(r) ? "-" : r.toFixed(1);
    pushEvent(id, `rate ${dev.rate}`);
    if(graphDevice === id) pushOverviewPoint(r);
  } else if(field === "drops"){
    dev.drops = payload;
    pushEvent(id, `drops ${payload}`);
  } else if(field === "status"){
    dev.status = payload;
    pushEvent(id, `status ${payload}`);
    if(payload === "COMPLETED") saveHistoryItem(id);
  } else if(field === "meta"){
    try{ dev.meta = JSON.parse(payload); } catch(e){}
  }
  updateUI();
}

/* ======= UI update helpers ======= */
function updateUI(){
  updateSidebar();
  updateTable();
  updateStats();
  updateCounts();
  renderHistoryList();
  renderStatusList();
}
function updateSidebar(){
  const list = document.getElementById("device-list"); list.innerHTML = "";
  Object.keys(devices).sort().forEach(id => {
    const d = devices[id];
    const div = document.createElement("div");
    div.className = "device-item";
    div.onclick = ()=> openDetail(id);
    div.innerHTML = `<div><div class="device-id">${id}</div><div class="device-meta">${d.status} · ${d.rate} dpm</div></div><div>▸</div>`;
    list.appendChild(div);
  });
}
function updateTable(){
  const tbody = document.getElementById("table-body"); tbody.innerHTML = "";
  Object.keys(devices).sort().forEach(id=>{
    const d = devices[id];
    const tr = document.createElement("tr");
    tr.innerHTML = `<td style="padding:8px">${id}</td><td style="padding:8px">${d.rate}</td><td style="padding:8px">${d.drops}</td><td style="padding:8px">${d.status}</td>`;
    tbody.appendChild(tr);
  });
}
function updateStats(){
  // pick graphDevice or first device
  const devKeys = Object.keys(devices);
  graphDevice = graphDevice || devKeys[0] || null;
  document.getElementById("graph-device").textContent = graphDevice || "-";
  let combinedDrops = 0; let currentRate = "-";
  devKeys.forEach(id => combinedDrops += Number(devices[id].drops || 0));
  if(graphDevice) currentRate = devices[graphDevice].rate || "-";
  document.getElementById("stat-rate").textContent = currentRate;
  document.getElementById("stat-drops").textContent = combinedDrops;
  document.getElementById("stat-active").textContent = devKeys.length;
}
function updateCounts(){
  let r=0,p=0,o=0;
  Object.values(devices).forEach(d=>{
    if(d.status === "RUNNING") r++;
    else if(d.status === "PAUSED") p++;
    else if(d.status === "OFFLINE") o++;
  });
  document.getElementById("count-running").textContent = r;
  document.getElementById("count-paused").textContent = p;
  document.getElementById("count-offline").textContent = o;
}

/* ======= Events & Logs ======= */
function pushEvent(deviceId, msg){
  const t = `${new Date().toLocaleTimeString()} [${deviceId}] ${msg}`;
  // live events area
  const live = document.getElementById("live-events");
  const el = document.createElement("div"); el.textContent = t; el.style.padding="6px 4px";
  live.prepend(el);
  // global live all
  const all = document.getElementById("live-all");
  const ael = document.createElement("div"); ael.textContent = t; ael.style.padding="6px 4px";
  all.prepend(ael);
  // per-device logs
  ensureDevice(deviceId);
  devices[deviceId].logs.unshift(t);
  if(devices[deviceId].logs.length>200) devices[deviceId].logs.pop();
  // detail panel update if open
  if(selectedDevice === deviceId){
    addDetailLog(t);
    updateDetailSummary(deviceId);
    pushDetailPoint(deviceId, Number(devices[deviceId].rate) || 0);
  }
}

/* ======= Chart handling ======= */
function initCharts(){
  const ctx = document.getElementById("overview-chart").getContext("2d");
  overviewChart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'Drip Rate', data: [], tension:0.3, borderWidth:2, borderColor: '#59A3BE', fill:true, backgroundColor:'rgba(89,163,190,0.12)'}]},
    options: { animation:false, responsive:true, scales:{x:{display:false}, y:{min:0,max:500}} }
  });

  const ctx2 = document.getElementById("detail-chart").getContext("2d");
  detailChart = new Chart(ctx2, {
    type:'line',
    data: { labels: [], datasets:[{label:'Rate', data:[], borderColor: '#2f88a8', fill:true, backgroundColor:'rgba(47,136,168,0.09)'}]},
    options:{animation:false,responsive:true,scales:{x:{display:false},y:{min:0,max:500}}}
  });
}
function pushOverviewPoint(val){
  if(!overviewChart) return;
  overviewChart.data.labels.push('');
  overviewChart.data.datasets[0].data.push(val);
  if(overviewChart.data.labels.length>60){ overviewChart.data.labels.shift(); overviewChart.data.datasets[0].data.shift();}
  overviewChart.update('none');
}
function pushDetailPoint(devId, val){
  if(!detailChart || selectedDevice !== devId) return;
  detailChart.data.labels.push('');
  detailChart.data.datasets[0].data.push(val);
  if(detailChart.data.labels.length>120){ detailChart.data.labels.shift(); detailChart.data.datasets[0].data.shift();}
  detailChart.update('none');
}

/* ======= Detail Panel ======= */
function openDetail(id){
  ensureDevice(id);
  selectedDevice = id;
  document.getElementById("detail-title").textContent = id;
  document.getElementById("detail-sub").textContent = `${devices[id].status} · last: ${devices[id].rate} dpm`;
  document.getElementById("detailPanel").classList.add('open');
  document.getElementById("detailPanel").ariaHidden = "false";
  document.getElementById("detail-logs").innerHTML = "";
  // populate logs
  (devices[id].logs || []).slice(0,100).forEach(l => {
    const li = document.createElement("div"); li.className = "log-item"; li.textContent = l;
    document.getElementById("detail-logs").appendChild(li);
  });
  updateDetailSummary(id);
  // reset detail chart
  detailChart.data.labels = []; detailChart.data.datasets[0].data = [];
  detailChart.update();
  graphDevice = id; document.getElementById("graph-device").textContent = id;
}
function closeDetail(){
  selectedDevice = null;
  document.getElementById("detailPanel").classList.remove('open');
  document.getElementById("detailPanel").ariaHidden = "true";
}
function addDetailLog(text){
  const cont = document.getElementById("detail-logs");
  const el = document.createElement("div"); el.className = "log-item"; el.textContent = text;
  cont.prepend(el);
}
function updateDetailSummary(id){
  const d = devices[id];
  document.getElementById("d-rate").textContent = d.rate || "-";
  document.getElementById("d-drops").textContent = d.drops || 0;
  document.getElementById("d-vol").textContent = d.meta.volume || "-";
  document.getElementById("d-rem").textContent = d.meta.remaining || "-";
}

/* ======= Pages ======= */
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(name).classList.add('active');
}

/* ======= History (localStorage) ======= */
const HISTORY_KEY = "dripstop_history_v1";
function saveHistoryItem(deviceId){
  // store snapshot
  const d = devices[deviceId];
  const item = { id: deviceId, time: nowISO(), rate: d.rate, drops: d.drops, meta: d.meta, status: d.status };
  const arr = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
  arr.unshift(item);
  localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(0,200)));
  renderHistoryList();
}
function renderHistoryList(){
  const el = document.getElementById("history-list"); el.innerHTML = "";
  const arr = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
  arr.forEach(it=>{
    const div = document.createElement("div"); div.className='card'; div.style.marginBottom='8px';
    div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><b>${it.id}</b> · ${new Date(it.time).toLocaleString()}</div><div>${it.status}</div></div>
    <div style="margin-top:6px;font-size:13px;color:var(--muted)">Rate:${it.rate} dpm · Drops:${it.drops}</div>
    <div style="margin-top:8px"><button class="btn" onclick='replayHistory(${JSON.stringify(JSON.stringify(it))})'>Open</button></div>`;
    el.appendChild(div);
  });
}
function replayHistory(jsonString){
  const it = JSON.parse(JSON.parse(jsonString));
  // Show in detail panel (quick)
  ensureDevice(it.id);
  devices[it.id].logs.unshift(`${new Date(it.time).toLocaleString()} [HISTORY] summary saved`);
  openDetail(it.id);
}
function clearHistory(){ localStorage.removeItem(HISTORY_KEY); renderHistoryList(); }

/* ======= Status & Live render ======= */
function renderStatusList(){
  const el = document.getElementById("status-list"); el.innerHTML = "";
  Object.keys(devices).forEach(id=>{
    const d = devices[id];
    const div = document.createElement("div"); div.style.padding="8px 0"; div.innerHTML = `<b>${id}</b> — ${d.status} · ${d.rate} dpm · last ${d.lastSeen?new Date(d.lastSeen).toLocaleTimeString():'-'}`
    el.appendChild(div);
  });
}

/* ======= Live Tracking (all events) ======= */
/* Already appended to #live-all in pushEvent */

/* ======= Commands ======= */
function sendCmdToSelected(cmd){
  if(!selectedDevice){ alert("Open a device detail first (click a device on left)"); return;}
  const topic = `infusion/${selectedDevice}/cmd`;
  const message = `${cmd}`;
  if(mqttConnected && client){
    const m = new Paho.MQTT.Message(message); m.destinationName = topic; client.send(m);
    pushEvent(selectedDevice, `CMD ${message}`);
  } else {
    pushEvent(selectedDevice, `CMD MOCK:${message}`);
  }
}

/* ======= Modal actions ======= */
function openStartModal(){ document.getElementById("startModal").style.display = "flex"; }
function closeStartModal(){ document.getElementById("startModal").style.display = "none"; }
function startInfusionFromModal(){
  const id = document.getElementById("m-device").value || "DEVICE_1";
  const vol = Number(document.getElementById("m-vol").value) || 500;
  const factor = Number(document.getElementById("m-factor").value) || 20;
  const duration = Number(document.getElementById("m-duration").value) || 60;
  ensureDevice(id);
  devices[id].meta = { volume: vol, factor, duration, remaining: `${Math.floor(duration/60)}h` };
  devices[id].status = "RUNNING"; devices[id].rate = (vol*factor/duration).toFixed(1);
  devices[id].drops = 0;
  pushEvent(id, `START vol=${vol} factor=${factor} dur=${duration}min`);
  closeStartModal(); updateUI();
}

/* Save current detail to history */
function saveHistoryCurrent(){
  if(!selectedDevice){ alert("Open a device first"); return; }
  saveHistoryItem(selectedDevice);
  alert("Saved to history");
}

/* ======= Mock mode generator ======= */
let mockInterval = null;
function toggleMock(){
  mockMode = !mockMode;
  if(mockMode){ startMock(); } else { stopMock(); }
}
function startMock(){
  // create a few devices
  ["DEVICE_1","DEVICE_2","DEVICE_3"].forEach((id,i)=>{
    ensureDevice(id);
    devices[id].status = i===0?"RUNNING":"ACTIVE";
    devices[id].rate = (30 + i*10).toFixed(1);
    devices[id].drops = 0;
    devices[id].meta = { volume:500, factor:20, duration:60, remaining:"1h" };
  });
  // emit updates
  mockInterval = setInterval(()=>{
    Object.keys(devices).forEach(id=>{
      if(devices[id].status === "RUNNING"){
        // wobble rate
        const base = Number(devices[id].rate) || 50;
        const delta = (Math.random()*6 - 3);
        devices[id].rate = Math.max(0, (base + delta)).toFixed(1);
        devices[id].drops = Number(devices[id].drops || 0) + Math.round(Math.random()*2);
        pushEvent(id, `mock-rate ${devices[id].rate}`);
        // occasionally complete
        if(Math.random() < 0.01){ devices[id].status = "COMPLETED"; pushEvent(id, "mock-completed"); saveHistoryItem(id) }
      }
    });
    updateUI();
  }, 800);
  setMqttStatus(false);
}
function stopMock(){
  clearInterval(mockInterval); mockInterval = null;
  Object.keys(devices).forEach(id=> { devices[id].status="OFFLINE"; devices[id].rate="-"; });
  updateUI();
  setMqttStatus(false);
}

/* ======= Initialization ======= */
function init(){
  initCharts();
  setupMQTT();
  // initial demo: if server shows disconnected, enable mock button until you toggle.
  renderHistoryList();
  updateUI();
}
init();

/* ======= Utility to open detail externally from history replay ======= */
window.openDetail = openDetail;

/* ======= For demo: expose some functions in console ======= */
window._devices = devices;
window._pushEvent = pushEvent;
window._saveHistory = saveHistoryItem;
</script>
</body>
</html>
