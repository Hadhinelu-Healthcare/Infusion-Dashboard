<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DripStop ICU Dashboard</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

<style>
:root { --blue:#59A3BE; }

body {
  margin:0;
  font-family: Inter, Arial;
  background:#F4FAFE;
}

.nav {
  background:var(--blue);
  color:white;
  font-size:22px;
  padding:16px;
  font-weight:bold;
}

.grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:18px;
  padding:20px;
}

.device-card {
  background:white;
  padding:18px;
  border-radius:16px;
  box-shadow:0 4px 14px rgba(0,0,0,0.08);
}

.battery {
  width:50px;
  height:22px;
  border:2px solid black;
  border-radius:5px;
  display:flex;
  gap:3px;
  padding:2px;
  position:relative;
}

.battery::after {
  content:"";
  width:6px;
  height:10px;
  background:black;
  position:absolute;
  right:-8px;
  top:5px;
  border-radius:3px;
}

.battery-bar {
  flex:1;
  background:#DDD;
  border-radius:3px;
}

.battery-fill { background:var(--blue); }
.battery-low { background:red; }

.charging {
  position:absolute;
  right:-28px;
  top:-6px;
  color:gold;
  font-size:18px;
}
</style>
</head>

<body>
<div class="nav">DripStop ICU Battery Dashboard</div>
<div class="grid" id="grid"></div>

<script>
let devices = {};
const client = new Paho.MQTT.Client("broker.hivemq.com",8884,"/mqtt","WEB_"+Math.random());

client.onMessageArrived = onMessage;
client.connect({useSSL:true,onSuccess:()=>{
  client.subscribe("infusion/+/batteryVoltage");
  client.subscribe("infusion/+/batteryPercent");
  client.subscribe("infusion/+/charging");
}});

function onMessage(msg){
  let parts = msg.destinationName.split("/");
  let dev = parts[1];
  let field = parts[2];
  let val = msg.payloadString;

  if(!devices[dev]) createDevice(dev);
  devices[dev][field] = val;
  updateBattery(dev);
}

function createDevice(dev){
  devices[dev] = {};
  document.getElementById("grid").innerHTML += `
    <div class="device-card" id="card-${dev}">
      <h3>${dev}</h3>
      <div class="battery" id="bat-${dev}">
        <div class="battery-bar"></div>
        <div class="battery-bar"></div>
        <div class="battery-bar"></div>
      </div>
      <div id="volt-${dev}">-- V</div>
    </div>`;
}

function updateBattery(dev){
  let v = parseFloat(devices[dev].batteryVoltage || 0);
  let p = parseInt(devices[dev].batteryPercent || 0);
  let c = devices[dev].charging || "0";

  document.getElementById("volt-"+dev).innerText = v.toFixed(2)+" V";

  let bars = document.querySelectorAll("#bat-"+dev+" .battery-bar");
  bars.forEach(b=>b.className="battery-bar");

  if(p > 20) bars[0].classList.add("battery-fill");
  if(p > 50) bars[1].classList.add("battery-fill");
  if(p > 80) bars[2].classList.add("battery-fill");

  if(p < 20){
    bars.forEach(b=>b.classList.add("battery-low"));
  }

  if(c=="1"){
    if(!document.getElementById("chg-"+dev))
      document.getElementById("bat-"+dev)
      .insertAdjacentHTML("beforeend",
        `<span class="charging" id="chg-${dev}">âš¡</span>`);
  }
}
</script>
</body>
</html>
