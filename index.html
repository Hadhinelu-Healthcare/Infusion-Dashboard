<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DripStop Dashboard</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- MQTT client -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --brand: #59A3BE;
      --brand-dark: #3F7E94;
      --bg: #F5F9FC;
      --card-bg: #ffffff;
      --text-dark: #1A1A1A;
      --text-light: #555;
      --radius: 14px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      color: var(--text-dark);
    }

    /* Header */
    .header {
      width: 100%;
      background: var(--brand);
      padding: 18px 28px;
      color: white;
      font-size: 28px;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Main container */
    .container {
      max-width: 1100px;
      margin: auto;
      padding: 20px;
    }

    /* Card style */
    .card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      margin-bottom: 24px;
    }

    .card h3 {
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 20px;
      color: var(--brand-dark);
    }

    label {
      font-weight: 600;
      color: var(--text-light);
    }

    input, select {
      padding: 8px;
      width: 220px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    button {
      padding: 10px 18px;
      background: var(--brand);
      color: white;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      transition: 0.2s;
    }

    button:hover {
      background: var(--brand-dark);
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th {
      background: var(--brand);
      color: white;
      padding: 12px;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }

    .status-ONLINE { color: green; font-weight: bold; }
    .status-INFUSING { color: blue; font-weight: bold; }
    .status-COMPLETED { color: purple; font-weight: bold; }
    .status-READY { color: orange; font-weight: bold; }

    .controls {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      align-items: center;
    }
  </style>
</head>

<body>

  <!-- Header -->
  <div class="header">
    DripStop Cloud Dashboard
  </div>

  <div class="container">
    
    <!-- START INFUSION CARD -->
    <div class="card">
      <h3>Start Infusion</h3>

      <div class="controls">
        <div>
          <label>Choose Device:</label><br>
          <select id="deviceId">
            <option value="DEVICE_1">DEVICE_1</option>
            <option value="DEVICE_2">DEVICE_2</option>
            <option value="DEVICE_3">DEVICE_3</option>
            <option value="DEVICE_4">DEVICE_4</option>
            <option value="DEVICE_5">DEVICE_5</option>
          </select><br>
        </div>

        <div>
          <label>Bottle Volume (mL):</label><br>
          <input id="bottle" type="number" value="500"><br>
        </div>

        <div>
          <label>Drop Factor (drops/mL):</label><br>
          <input id="dropFactor" type="number" value="20"><br>
        </div>

        <div>
          <label>Duration (minutes):</label><br>
          <input id="duration" type="number" value="60"><br>
        </div>

        <div style="align-self:flex-end">
          <button id="startBtn">START</button>
        </div>
      </div>
    </div>

    <!-- DEVICE TABLE -->
    <div class="card">
      <h3>Live Device Status</h3>

      <table>
        <thead>
          <tr>
            <th>Device ID</th>
            <th>Drip Rate (drops/min)</th>
            <th>Total Drops</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="device-table-body"></tbody>
      </table>
    </div>

    <!-- GRAPH CARD -->
    <div class="card">
      <h3>Live Drip Rate Graph â€” <span id="graph-device-label">DEVICE_1</span></h3>
      <canvas id="rateChart" style="height: 300px;"></canvas>
    </div>

  </div>


<!-- ======================= JAVASCRIPT ======================= -->

<script>
  /* -------------------- MQTT Secure Connection --------------------- */

  var host = "broker.hivemq.com";
  var port = 8884;           
  var path = "/mqtt";
  var clientId = "DRIPSTOP_WEB_" + Date.now();

  var client = new Paho.MQTT.Client(host, port, path, clientId);
  var devices = {};
  var selectedDevice = "DEVICE_1";
  var currentGraphDevice = "DEVICE_1";

  // start button
  document.addEventListener("DOMContentLoaded", function(){
    document.getElementById("startBtn").addEventListener("click", startInfusion);
    document.getElementById("deviceId").addEventListener("change", function(e){
      selectedDevice = e.target.value;
      currentGraphDevice = selectedDevice;
      document.getElementById("graph-device-label").textContent = selectedDevice;
      // clear chart data for new device
      chartData.labels = [];
      chartData.datasets[0].data = [];
      rateChart.update();
    });
  });

  /* -------------------- LIVE GRAPH SETUP --------------------- */

  var chartData = {
    labels: [],
    datasets: [{
      label: "Drip Rate (drops/min)",
      borderColor: "#59A3BE",
      backgroundColor: "rgba(89,163,190,0.2)",
      data: []
    }]
  };

  var ctx = document.getElementById('rateChart').getContext('2d');
  var rateChart = new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      tension: 0.35,
      animation: false,
      scales: {
        x: { display: false },
        y: {
          beginAtZero: true,
          suggestedMin: 0,
          suggestedMax: 500,
          max: 500,
          ticks: {
            stepSize: 50
          }
        }
      }
    }
  });

  let lastGraphUpdate = 0;
  function updateGraph(rate) {
    const now = Date.now();

    // add data
    chartData.labels.push(now);
    chartData.datasets[0].data.push(rate);

    // limit length
    if (chartData.labels.length > 60) {
      chartData.labels.shift();
      chartData.datasets[0].data.shift();
    }

    // throttle redraw (400ms)
    if (now - lastGraphUpdate > 400) {
      rateChart.update();
      lastGraphUpdate = now;
    }
  }

  /* -------------------- MQTT EVENTS --------------------- */

  client.onConnectionLost = function (responseObject) {
    console.error("MQTT lost:", responseObject ? responseObject.errorMessage : "unknown");
    setTimeout(connect, 2000);
  };

  client.onMessageArrived = function (message) {
    var topic = message.destinationName;
    var payload = message.payloadString;

    // topic example: infusion/DEVICE_1/rate
    var parts = topic.split("/");
    if (parts.length < 3) return;
    var deviceId = parts[1];
    var field = parts[2];

    // ensure row visible
    ensureRow(deviceId);

    // fast updates
    if (field === "rate") {
      var r = parseFloat(payload);
      if (!isNaN(r)) {
        document.getElementById(deviceId + "-rate").textContent = r.toFixed(1);
        // update graph only for current graph device
        if (deviceId === currentGraphDevice) updateGraph(r);
      }
    } else if (field === "drops") {
      document.getElementById(deviceId + "-drops").textContent = payload;
    } else if (field === "status") {
      var cell = document.getElementById(deviceId + "-status");
      cell.textContent = payload;
      cell.className = "status-" + payload;
    }
  };

  function connect() {
    console.log("Connecting to MQTT...");
    client.connect({
      onSuccess: function () {
        console.log("Connected to broker (WSS)");
        client.subscribe("infusion/+/rate");
        client.subscribe("infusion/+/drops");
        client.subscribe("infusion/+/status");
      },
      onFailure: function (err) {
        console.error("MQTT connect failed:", err.errorMessage);
        setTimeout(connect, 2000);
      },
      useSSL: true
    });
  }
  connect();

  /* -------------------- SEND START COMMAND --------------------- */

  function startInfusion() {
    selectedDevice = document.getElementById("deviceId").value;
    currentGraphDevice = selectedDevice;
    document.getElementById("graph-device-label").textContent = selectedDevice;

    var bottle = document.getElementById("bottle").value || "500";
    var df = document.getElementById("dropFactor").value || "20";
    var dur = document.getElementById("duration").value || "60";

    var topic = "infusion/" + selectedDevice + "/cmd";
    var payload = "START:" + bottle + "," + df + "," + dur;

    var msg = new Paho.MQTT.Message(payload);
    msg.destinationName = topic;
    client.send(msg);

    alert("START sent to " + selectedDevice);
  }

  /* -------------------- DEVICE TABLE --------------------- */

  function ensureRow(device) {
    if (!devices[device]) {
      devices[device] = { rate: "-", drops: "-", status: "-" };

      var row = `
        <tr id="row-${device}">
          <td>${device}</td>
          <td id="${device}-rate">-</td>
          <td id="${device}-drops">-</td>
          <td id="${device}-status">-</td>
        </tr>
      `;
      document.getElementById("device-table-body").insertAdjacentHTML("beforeend", row);
    }
  }

</script>

</body>
</html>
